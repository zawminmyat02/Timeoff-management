<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{/layouts/user-board.html}">

<head>
<meta name="_csrf" th:content="${_csrf.token}" />
<meta name="_csrf_header" th:content="${_csrf.headerName}" />
<title>Title</title>
<style>
.rounded-circle {
	width: 50px;
	height: 50px;
}

.main-content {
	flex-grow: 1;
	display: flex;
	flex-direction: column;
	overflow: auto;
	padding: 20px;
}

.header, .footer {
	background-color: #d8efd3;
	padding: 10px;
	text-align: center;
	color: #000;
	box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
	margin-bottom: 20px;
}

.container {
	background-color: #d8efd3;
	border-radius: 12px;
	box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5);
	transition: transform 0.3s, box-shadow 0.3s;
	padding: 30px;
	margin-bottom: 20px;
	flex-grow: 1;
}

.container:hover {
	transform: translateY(-5px);
	box-shadow: 0 12px 24px rgba(0, 0, 0, 0.5);
}

h1 {
	text-align: center;
	color: #000;
	margin-bottom: 20px;
}

label {
	display: block;
	margin-top: 20px;
	color: #000;
	font-weight: 700;
}

input, select, textarea {
	width: calc(100% - 30px);
	padding: 15px;
	margin-top: 10px;
	background-color: #d8efd3;
	border: 1px solid #000;
	border-radius: 8px;
	color: #000;
	font-size: 16px;
	transition: background-color 0.3s, border-color 0.3s;
}

input:focus, select:focus, textarea:focus {
	background-color: #d8efd3;
	border-color: #55ad9b;
	outline: none;
}

.tooltip {
	position: relative;
	display: inline-block;
	cursor: pointer;
}

.progress-tracker {
	display: flex;
	justify-content: space-between;
	margin-bottom: 20px;
	margin-right: 30px;
}

.progress-step {
	width: 30%;
	text-align: center;
	padding: 10px;
	background-color: #95d2b3;
	border-radius: 8px;
	transition: background-color 0.3s;
}

.progress-step.active {
	background-color: #d8efd3;
}

.tooltip .tooltiptext {
	visibility: hidden;
	width: 200px;
	background-color: #d8efd3;
	color: #000;
	text-align: center;
	border-radius: 6px;
	padding: 5px 0;
	position: absolute;
	z-index: 1;
	bottom: 125%;
	left: 50%;
	margin-left: -100px;
	opacity: 0;
	transition: opacity 0.3s;
}

.tooltip:hover .tooltiptext {
	visibility: visible;
	opacity: 1;
}

button {
	width: calc(100% - 30px);
	padding: 15px;
	margin-top: 30px;
	background-color: #55ad9b;
	border: none;
	border-radius: 8px;
	color: #000;
	font-size: 18px;
	font-weight: 700;
	cursor: pointer;
	transition: background-color 0.3s, transform 0.3s;
	font-weight: 400;
}

button:hover {
	background-color: #55ad9b;
	transform: translateY(-2px);
}

button:active {
	background-color: #55ad9b;
	transform: translateY(0);
}

.leave-balance, .recent-leaves {
	background-color: #d8efd3;
	padding: 20px;
	border-radius: 8px;
	margin: 10px 0;
	color: #000;
}

.leave-balance h2, .recent-leaves h2 {
	color: #000;
	margin-bottom: 10px;
}

.leave-balance ul, .recent-leaves ul {
	list-style: none;
	padding: 0;
}

.leave-balance li, .recent-leaves li {
	padding: 10px;
	border-bottom: 1px solid #000;
}

.leave-balance li:last-child, .recent-leaves li:last-child {
	border-bottom: none;
}

.progress {
	display: flex;
	justify-content: space-between;
	margin-bottom: 20px;
}

.progress-step.active {
	background-color: #55ad9b;
	color: #000;
}

.step-content {
	display: none;
}

.step-content.active {
	display: block;
}

#step2 {
	padding: 20px;
	background-color: #d8efd3;
	border-radius: 8px;
	box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

#step2 h2 {
	color: #000;
	margin-bottom: 15px;
}

#step2 p {
	color: #000;
	margin-bottom: 20px;
}

.review-details {
	padding: 15px;
	background-color: #d8efd3;
	border: 1px solid #000;
	border-radius: 4px;
	margin-bottom: 20px;
}

.button-group {
	display: flex;
	justify-content: space-between;
}

.btn {
	padding: 10px 20px;
	border: none;
	border-radius: 25px;
	cursor: pointer;
	font-size: 16px;
	transition: background-color 0.3s ease, box-shadow 0.3s ease;
	color: #000;
}

h2, h4, p {
	color: #000;
}

.btn-secondary {
	background: #d8efd3;
	color: #000;
	border: 2px solid #000;
	margin-top: 10px;
}

.btn-secondary:hover {
	background: #d8efd4;
	color: #000;
	border: 2px solid #000;
	box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
	margin-top: 10px;
}

.btn-primary {
	background: #55ad9b;
	color: #000;
}

.btn-primary:hover {
	background: #55ad9c;
	color: #000;
	box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.confirmation-message {
	padding: 15px;
	background-color: #d8efd3;
	border: 1px solid #000;
	border-radius: 4px;
	margin-bottom: 20px;
	color: #000;
}

.alert {
	color: #ff0000;
	margin-top: 10px;
	margin-bottom: 10px;
	font-size: 14px;
}


@media (max-width: 767px) {

	 main.col-10 {
        margin-left: 50px; /* Sidebar is always visible, so push the content */
    }
}
</style>
</head>

<body>
	<section layout:fragment="content">
		<div class="container">
			<h1 style="color: #000; font-size: 24px; margin-top: 10px; margin-bottom: 40px">Leave Request</h1>
			<div class="progress-tracker">
				<div id="step1-indicator" class="progress-step active">Step 1:
					Details</div>
				<div id="step2-indicator" class="progress-step">Step 2: Review</div>
				<div id="step3-indicator" class="progress-step">Step 3: Submit</div>
			</div>
			<form id="leaveRequestForm" th:action="@{/leave-application/submit}"
				method="post">
				<!-- Step 1: Details -->
				<div id="step1" class="step-content active">
					<input type="hidden" id="employeeCode" name="employeeCode"
						th:value="${employeeCode}"> <label for="leaveType">Leave
						Type:</label> <select id="leaveType" name="leaveTypeId" required>
						<option th:each="leaveType : ${leaveTypes}"
							th:value="${leaveType.id}" th:text="${leaveType.name}"></option>
					</select> <label for="startDate">Start Date:</label> <input type="date"
						id="startDate" name="startDate" required> <label
						for="endDate">End Date:</label> <input type="date" id="endDate"
						name="endDate" required> <label for="remark">Remark:</label>
					<textarea id="remark" name="remark" rows="4" required></textarea>
					<div class="alert alert-danger" id="errorAlert"></div>
					<button id="nextStep1" type="button">Next Step</button>
				</div>
				<!-- Step 2: Review -->
				<div id="step2" class="step-content" style="display: none;">
					<h2>Review Details</h2>
					<p>Please review your leave request details:</p>
					<div id="reviewDetails" class="review-details"></div>
					<div class="button-group">
						<button id="prevStep2" type="button" class="btn btn-secondary">Previous
							Step</button>
						<button id="nextStep2" type="button" class="btn btn-primary">Next
							Step</button>
					</div>
				</div>
				<!-- Step 3: Submit -->
				<div id="step3" class="step-content" style="display: none;">
					<div class="mb-5"></div>
					<h2>Confirmation</h2>
					<p>Your leave request is about to submit!!</p>
					<div class="confirmation-message">
						<p>We would like to remind you of our leave policy regarding
							unpaid leave.</p>
						<p>If you take unpaid leave, 80% of your daily salary will be
							deducted for each day of unpaid leave.</p>
						<p>To avoid any unexpected deductions, we encourage you to
							check your available leave balance in your leave balance box
							before applying for leave.</p>
						<p>Thank you for your understanding and cooperation.</p>
						<p>And get back soon.</p>
					</div>

					<div class="button-group">
						<button id="prevStep3" type="button" class="btn btn-secondary">Previous
							Step</button>
						<button id="submit" type="submit" class="btn btn-primary">Submit</button>
					</div>
				</div>
			</form>
		</div>

		<script>
        document.addEventListener("DOMContentLoaded", function () {
            const step1 = document.getElementById('step1');
            const step2 = document.getElementById('step2');
            const step3 = document.getElementById('step3');
            const step1Indicator = document.getElementById('step1-indicator');
            const step2Indicator = document.getElementById('step2-indicator');
            const step3Indicator = document.getElementById('step3-indicator');
            const nextStep1Button = document.getElementById('nextStep1');
            const nextStep2Button = document.getElementById('nextStep2');
            const prevStep2Button = document.getElementById('prevStep2');
            const prevStep3Button = document.getElementById('prevStep3');
            const submitButton = document.getElementById('submit');
            document.getElementById('errorAlert').style.display = 'none';
            
            const maternityLeaveDuration = parseInt(`[[${maternity}]]`, 10); // Ensure it's a number
            console.log("Maternity Leave Duration:", maternityLeaveDuration);



            function getCsrfToken() {
                return document.querySelector('meta[name="_csrf"]').getAttribute('content');
            }

            function getCsrfHeaderName() {
                return document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
            }

            async function checkDateOverlap(startDate, endDate, employeeCode) {
                const csrfToken = getCsrfToken();
                const csrfHeaderName = getCsrfHeaderName();

                const response = await fetch('/checkOverlap', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeaderName]: csrfToken
                    },
                    body: JSON.stringify({
                        startDate: startDate,
                        endDate: endDate,
                        employeeCode: employeeCode
                    })
                });

                const result = await response.json();
                return result.isOverlap;
            }
            
            function updateEndDateIfMaternityLeave() {
                const startDateElement = document.getElementById('startDate');
                const leaveTypeElement = document.getElementById('leaveType');
                const endDateElement = document.getElementById('endDate');



            	const selectedLeaveType = leaveTypeElement.value;
                const startDateValue = startDateElement.value;

                // Assuming 'Maternity Leave' has a specific ID (replace with actual ID)
                const maternityLeaveTypeId = 3; // Replace with actual ID for "Maternity Leave"

                if (selectedLeaveType == maternityLeaveTypeId && startDateValue) {// Replace "3" with your actual maternity leave type ID
                	const startDate = new Date(startDateValue);

                    // Create a new date object for endDate without mutating the startDate
                    const endDate = new Date(startDate.getTime());

                    // Add the maternity leave duration in days and subtract 1 day
                    endDate.setUTCDate(startDate.getUTCDate() + maternityLeaveDuration - 1);

                    // Format the date as YYYY-MM-DD and set it to endDate input field
                    const formattedEndDate = endDate.toISOString().split('T')[0];
                    endDateElement.value = formattedEndDate;

                    console.log("Maternity Leave Duration:", maternityLeaveDuration);
                    console.log("Start Date:", startDate);
                    console.log("Calculated End Date:", endDate);
                    console.log("Adjusted End Date:", formattedEndDate);
                  
                }
            }


            async function validateForm() {
                const leaveType = document.getElementById('leaveType').value;
                const startDateValue = document.getElementById('startDate').value;
                const endDateValue = document.getElementById('endDate').value;
                const remark = document.getElementById('remark').value;
                const employeeCode = document.getElementById('employeeCode').value; // Get the employeeCode from the form
                const error = document.getElementById('errorAlert');
                const today = new Date();
                const startDate = new Date(startDateValue);
                const endDate = new Date(endDateValue);
                today.setHours(0, 0, 0, 0);
                
                console.log(startDate.toISOString())

                error.innerHTML = '';

                if (!leaveType || !startDate || !endDate || !remark) {
                    document.getElementById('errorAlert').style.display = 'block';
                    error.innerHTML += '<p>All fields are required.</p>';
                    return false;
                }

                if (startDate < today) {
                    document.getElementById('errorAlert').style.display = 'block';
                    error.innerHTML += '<p>Start date cannot be earlier than today.</p>';
                    return false;
                }

                if (endDate < startDate) {
                    document.getElementById('errorAlert').style.display = 'block';
                    error.innerHTML += '<p>End date must be later than start date.</p>';
                    return false;
                }

                try {
                	 const startDateUTC = startDate.toISOString().split('T')[0];
                     const endDateUTC = endDate.toISOString().split('T')[0];
                     const isOverlap = await checkDateOverlap(startDateUTC, endDateUTC, document.getElementById('employeeCode').value);
                     if (isOverlap) {
                        document.getElementById('errorAlert').style.display = 'block';
                        error.innerHTML += '<p>The selected dates overlap with an existing leave.</p>';
                        return false;
                    } else {
                        document.getElementById('errorAlert').style.display = 'none';
                        return true;
                    }
                } catch (e) {
                    console.error("Error checking date overlap:", e);
                    document.getElementById('errorAlert').style.display = 'block';
                    error.innerHTML += '<p>There was an error checking date overlap. Please try again.</p>';
                    return false;
                }
            }
            
            document.getElementById('leaveType').addEventListener("change", updateEndDateIfMaternityLeave);
            document.getElementById('startDate').addEventListener("change", updateEndDateIfMaternityLeave);


            function populateReviewDetails() {
                const leaveTypeElement = document.getElementById('leaveType');
                const leaveTypeName = leaveTypeElement.options[leaveTypeElement.selectedIndex].text;
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                const remark = document.getElementById('remark').value;

                const reviewDetails = document.getElementById('reviewDetails');
                reviewDetails.innerHTML = `
                    <p><strong>Leave Type:</strong> ${leaveTypeName}</p>
                    <p><strong>Start Date:</strong> ${startDate}</p>
                    <p><strong>End Date:</strong> ${endDate}</p>
                    <p><strong>Remark:</strong> ${remark}</p>
                `;
            }

            nextStep1Button.addEventListener('click', async function () {
                const isValid = await validateForm();
                if (isValid) {
                    step1.style.display = 'none';
                    step2.style.display = 'block';
                    step1.classList.remove('active');
                    step2.classList.add('active');
                    step1Indicator.classList.remove('active');
                    step2Indicator.classList.add('active');
                    populateReviewDetails();
                }
            });

            nextStep2Button.addEventListener('click', function () {
                step2.style.display = 'none';
                step3.style.display = 'block';
                step2.classList.remove('active');
                step3.classList.add('active');
                step2Indicator.classList.remove('active');
                step3Indicator.classList.add('active');
            });

            prevStep2Button.addEventListener('click', function () {
                step2.style.display = 'none';
                step1.style.display = 'block';
                step2.classList.remove('active');
                step1.classList.add('active');
                step2Indicator.classList.remove('active');
                step1Indicator.classList.add('active');
            });

            prevStep3Button.addEventListener('click', function () {
                step3.style.display = 'none';
                step2.style.display = 'block';
                step3.classList.remove('active');
                step2.classList.add('active');
                step3Indicator.classList.remove('active');
                step2Indicator.classList.add('active');
            });

           
        });
        
        document.addEventListener("DOMContentLoaded", function () {
          
        });

    </script>

	</section>
</body>
</html>